# Main pagination query
query GetEventsFeed(
  $limit: Int
  $offset: Int
  $addresses: [String!]!
  $address: String!
  $Where: events_bool_exp
) {
  total: events_aggregate(
    where: {
      _and: [
        {
          _or: [
            { deposit: { sender_id: { _in: $addresses } } }
            { redemption: { sender_id: { _in: $addresses } } }
          ]
        }
      ]
    }
  ) {
    aggregate {
      count
    }
  }
  events(
    limit: $limit
    offset: $offset
    order_by: { created_at: desc }
    where: {
      _and: [
        {
          _or: [
            { deposit: { sender_id: { _in: $addresses } } }
            { redemption: { sender_id: { _in: $addresses } } }
          ]
        }
      ]
    }
  ) {
    id
    block_number
    created_at
    type
    transaction_hash
    atom_id
    triple_id
    deposit_id
    redemption_id
    atom {
      ...AtomMetadata
      term {
        vaults(where: { curve_id: { _eq: "1" } }) {
          total_shares
          position_count
          positions(where: { account: { id: { _in: $addresses } } }) {
            account_id
            shares
            account {
              id
              label
              image
            }
          }
        }
      }
    }
    triple {
      creator {
        ...AccountMetadata
      }
      subject {
        data
        term_id
        image
        label
        emoji
        type
        ...AtomValue
        creator {
          ...AccountMetadata
        }
      }
      predicate {
        data
        term_id
        image
        label
        emoji
        type
        ...AtomValue
        creator {
          ...AccountMetadata
        }
      }
      object {
        data
        term_id
        image
        label
        emoji
        type
        ...AtomValue
        creator {
          ...AccountMetadata
        }
      }
      term_id
      term {
        positions_aggregate {
          aggregate { count }
        }
        positions(where: { account_id: { _ilike: $address } }) {
          shares
          account_id 
        }
        vaults(where: { curve_id: { _eq: "1" } }) {
          total_shares
          position_count
          positions(where: { account: { id: { _in: $addresses } } }) {
            account_id
            shares
            account {
              id
              label
              image
            }
          }
        }
      }
      counter_term_id
      counter_term {
        positions_aggregate {
          aggregate { count }
        }
        positions(where: { account_id: { _ilike: $address } }) {
          shares
          account_id 
        }
        vaults(where: { curve_id: { _eq: "1" } }) {
          total_shares
          position_count
          positions(where: { account: { id: { _in: $addresses } } }) {
            account_id
            shares
            account {
              id
              label
              image
            }
          }
        }
      }
    }
    deposit {
      sender_id
      sender {
        id
        label
        image
      }
      vault {
        total_shares
        position_count
        positions(where: { account: { id: { _in: $addresses } } }) {
          account_id
          shares
          account {
            id
            label
            image
          }
        }
      }
    }
    redemption {
      sender_id
      sender {
        id
        label
        image
      }
    }
  }
}

# Combined query with aggregates and nodes
query GetEventsWithAggregates(
  $limit: Int
  $offset: Int
  $orderBy: [events_order_by!]
  $where: events_bool_exp
  $addresses: [String!]
) {
  events_aggregate(
    where: $where
    limit: $limit
    offset: $offset
    order_by: $orderBy
  ) {
    aggregate {
      count
      max {
        created_at
        block_number
      }
      min {
        created_at
        block_number
      }
    }
    nodes {
      ...EventDetails
    }
  }
}

